from dmp import DMP
import numpy as np
import math
import matplotlib.pyplot as plt
from draw_ani import draw_ani
import time
import matplotlib.animation as animation
import pandas as pd


l1 = 105  # Length of link 1
l2 = 113.7  # length of link 2


def plot_letter(predict_th1, predict_th2):
    X = []
    Y = []

    for i in range(len(predict_th1)):
        x, y = forward(predict_th1[i], predict_th2[i])
        X.append(x)
        Y.append(y)

    draw_ani(X, Y)
    # plt.plot(X, Y)
    plt.show()


def forward(theta1, theta2):
    x = - l1 * math.sin(theta1) + l2 * math.cos(math.pi / 2 + theta1 + theta2)
    y = l1 * math.cos(theta1) + l2 * math.sin(math.pi / 2 + theta1 + theta2)
    return x, y


def w_update(w1_old, w2_old, perturb):
    w = np.append(w1_old, w2_old)
    w += perturb

    return w[:10], w[10:]


def PoWER_roll_out(w1, w2, g1, g2, x10, x20, PHI1, PHI2):
    e_w_list = []
    reward_list = []
    for i in range(10):
        e_w = np.append(w1, w2) * 0.03 * np.random.randn(20)
        e_w_list.append(e_w)
        w1_new, w2_new = w_update(w1, w2, e_w)

        predict_s1 = dmp.predict(w1_new, x10, g1, PHI1)
        predict_s2 = dmp.predict(w2_new, x20, g2, PHI2)
        original_ss1 = dmp.predict(w1, th1[2], th1[-1], PHI1)
        original = dmp.predict(w2, th2[2], th2[-1], PHI2)

        X = []
        Y = []
        for idx in range(len(original_ss1)):
            x, y = forward(original_ss1[idx], original[idx])
            X.append(x)
            Y.append(y)

        plot_letter(predict_s1, predict_s2)

        touch_count = float(raw_input('Touch number: '))
        reward = np.exp(-0.04 * float(touch_count))
        reward_list.append(reward)

    print "roll-outs collection finished"

    w_epsilon = np.zeros_like(e_w_list[0])
    weight_d = 0
    for idx in range(len(reward_list)):
        w_epsilon += e_w_list[idx] * float(reward_list[idx])
        weight_d += reward_list[idx]

    delta_w = w_epsilon / float(weight_d)
    w1_new, w2_new = w_update(w1, w2, delta_w)

    return w1_new, w2_new


if __name__ == '__main__':
    th1 = [-0.24230000000000018, -0.235107719298971, -0.22980571437878994, -0.2234907720711128, -0.21712825836893623, -0.2134376315240809, -0.20699813247649534, -0.20601079269763134, -0.20227381047725812, -0.1995141226617434, -0.19752635330209212, -0.19553405331669116, -0.1935372042570369, -0.1915357873276733, -0.1895297833802343, -0.1875191729073391, -0.1855039806242249, -0.18449459870956408, -0.18247238421703837, -0.17943048718428534, -0.1784138559200945, -0.17637749910649192, -0.17535776910250078, -0.1751051695182071, -0.17381880937288585, -0.17354466970107563, -0.17223240927980088, -0.17193752923609318, -0.17060017311617082, -0.17028384860589574, -0.17203532432960977, -0.17234424111848656, -0.17494298290244736, -0.17577368542030025, -0.17653618248338487, -0.17675244865798345, -0.17945409747896002, -0.18203559411289816, -0.1854854379658104, -0.18834532901942347, -0.18921395835380928, -0.18900538958000035, -0.19088040321021138, -0.1927324972789317, -0.1920684226037246, -0.19350822004618706, -0.19283164743604742, -0.19426156710819775, -0.19568534478993183, -0.1953489510357076, -0.1953276546186209, -0.19419116716917495, -0.1954286066364792, -0.19764871780378113, -0.19872157903782317, -0.20078365533253506, -0.20147639162053, -0.20191478627671877, -0.20253480901932663, -0.20311167055947466, -0.20381472460844252, -0.206748543590352, -0.20861617026975843, -0.21131767973402615, -0.21275594230799566, -0.21521485285110997, -0.21538842211564768, -0.21661229798655457, -0.22000637243965349, -0.22225380619373425, -0.22444265796824947, -0.22659257684876088, -0.22657429982552957, -0.22871191849362305, -0.22977550197696317, -0.23294674458072762, -0.2348257631268873, -0.23750185453171957, -0.23699879975725668, -0.23750669899977095, -0.23792719694709463, -0.23809623937137192, -0.24110255952756598, -0.24391359699712334, -0.245896020071515, -0.24827962930366154, -0.249497388347935, -0.25094172672021386, -0.25151642194405377, -0.25207881019814105, -0.25459179404673415, -0.25512748986967937, -0.2556516459601901, -0.2564737555786556, -0.2572933882348658, -0.2572933882348658, -0.2581105522034195, -0.2581105522034195, -0.26036746290211643, -0.26343841909518595, -0.2676318174723118, -0.2706951520107701, -0.27600390031211575, -0.280989412829306, -0.2874051411328431, -0.2926901943121034, -0.2987705786217183, -0.3029244535034963, -0.3078706376801992, -0.31313056595330657, -0.31806217849043206, -0.3221966801844711, -0.3271159188181447, -0.3353646766290761, -0.3436001566800957, -0.3477128126066251, -0.35293117956978604, -0.3573614620468051, -0.3625705830502284, -0.36698935709020253, -0.37218895271528707, -0.3765973106851943, -0.3809992579099104, -0.38649242155694674, -0.3930712431667651, -0.3985422709855446, -0.40291201462747406, -0.4061848295854724, -0.41054322263033693, -0.41489462582717884, -0.4170681213529248, -0.4162599383562635, -0.4162599383562635, -0.4146374469621592, -0.4151737628229446, -0.4186801374695033, -0.42374573788003245, -0.42982061227991775, -0.43774071795776814, -0.44347450734131955, -0.4484800061242642, -0.4523388892804898, -0.4562592825001872, -0.4582261366933673, -0.4608373476361023, -0.4603452019183303, -0.46164897721482, -0.46288519267385575, -0.46405358532674734, -0.46316138802399753, -0.4631879375522119, -0.46417549006569514, -0.46414950876908456, -0.4611063034543783, -0.45599156056176127, -0.42957230100658794, -0.4174726448601631, -0.40831065330027005, -0.39892163129579616, -0.37205335096524683, -0.36173557869926243, -0.3527722224675971, -0.3423085298060895, -0.32887832159824226, -0.3178338577479134, -0.30650308823848427, -0.29926708781278255, -0.2933884225462091, -0.2889249439041588, -0.28441338361993784, -0.28137821645696715, -0.27678323103934943, -0.27213614655193985, -0.2674353279861861, -0.26427072896511916, -0.261080959254667, -0.25947645825969556, -0.25786545170361186, -0.25786545170361186, -0.2562478667747874, -0.2562478667747874, -0.25462362924895565, -0.25462362924895565, -0.25462362924895565, -0.25299266345096627, -0.25299266345096627, -0.25299266345096627, -0.25947645825969556, -0.27832064082117247, -0.285922708570296, -0.2933884225462091, -0.29926708781278255, -0.3050656583486884, -0.31078692050265344, -0.3150285126665535, -0.32062081147218424, -0.32751290379448394, -0.33295008348393607, -0.338321338575575, -0.3423085298060895, -0.3462608312397495, -0.3501790102757023, -0.3527722224675971, -0.35663515741097385, -0.36046587272348596, -0.36678028512887595, -0.3717707632595699, -0.3754785498751496, -0.37915765365571374, -0.38280817141549495, -0.3852259378213714, -0.38882998643532796, -0.3924068255773998, -0.39595693912375807, -0.40297841834685855, -0.4076029568816182, -0.4121833904185519, -0.41672067165508, -0.4189732110754689, -0.4223328740318961, -0.4245599019970716, -0.42677634014148325, -0.4289826993456023, -0.4322739591631253, -0.43879041501858884, -0.4430866610447388, -0.44522048066866304, -0.4484042072845731, -0.4505149609352814, -0.4515673119323558, -0.4546479202131093, -0.4567375075820952, -0.4588178394341642, -0.4629086890474352, -0.46496821726078963, -0.4680417788176172, -0.4710695337020563, -0.47310072526432845, -0.4751231971406682, -0.47813009354893854, -0.47913466397491344, -0.48213155444355604, -0.48412406768085803, -0.485121657776578, -0.4881058492241701, -0.49108354347829875, -0.49405511493467014, -0.4970211075727988, -0.4999808071469909, -0.5029351137168421, -0.5058833150111519, -0.5088263038980221, -0.5107633262994016, -0.5136945740781163, -0.5156586492247104, -0.5166201072723138, -0.5185823086642873, -0.5195839575643779, -0.5205430582166146, -0.5225028123912487, -0.5244614987925056, -0.5254168450420107, -0.5273734403278632, -0.5293290117463938, -0.5312836194400665, -0.5332373234783676, -0.5341864704422239, -0.5361381248024901, -0.5380889182172757, -0.5400387772530757, -0.5419251779793919, -0.5438721535132318, -0.5458182475215505, -0.5477638628751769, -0.5516520436106194, -0.5535949823128408, -0.5565445866255425, -0.5584861693117067, -0.5604270660848267, -0.5623672022758077, -0.5633743833982585, -0.5653144151069418, -0.5672533767794645, -0.5672533767794645, -0.5672533767794645, -0.5682605110459837, -0.5691917131045732, -0.5701990217351125, -0.5701990217351125, -0.5701990217351125, -0.5731437587701973, -0.574150518122487, -0.5760883531767476, -0.5781003175536189, -0.5800380982213799, -0.5810433051178113, -0.5829807221056293, -0.5829807221056293, -0.5839856394103534, -0.5839856394103534]
    th2 = [0.8540000000000006, 0.8446295989846857, 0.8363668628652521, 0.8274000603440989, 0.8183286090445737, 0.8134318995457206, 0.8041913713718354, 0.8035364164889479, 0.7985361549260406, 0.7941699435795456, 0.7928280877753477, 0.7914761597255513, 0.790114116570045, 0.7887419148054934, 0.7873595102739573, 0.7859668581512359, 0.7845639440540114, 0.7838585816254804, 0.7824401100529063, 0.7802930123153442, 0.7795718573171647, 0.7781219790044744, 0.7773932456520696, 0.7796967992186707, 0.7812473414118971, 0.7835149546843974, 0.7850216953084719, 0.7872543200771661, 0.7887181871525, 0.790915492483275, 0.8018304022716105, 0.8068280303162411, 0.8181876522970967, 0.8258151077881141, 0.8333312230301806, 0.8426709733361982, 0.8514788054945635, 0.869080382061112, 0.8826626068699694, 0.8935022073677188, 0.8984784373056464, 0.9026432321287372, 0.9083174827487954, 0.91395365514281, 0.9155990419235649, 0.918781398440482, 0.9204075448847341, 0.9235740379115577, 0.9267291251822878, 0.9306951817663172, 0.9369618933739154, 0.9423635481560836, 0.9515304443627293, 0.9613548953373304, 0.970266651138559, 0.9798448252448674, 0.986356911761582, 0.9906626040299779, 0.9970648579884381, 1.003401308568611, 1.01175128756201, 1.0236332506229862, 1.0365580582421683, 1.0480871596553631, 1.056719927728497, 1.066058051260801, 1.0717975268970927, 1.0782858676632119, 1.0881969561672349, 1.0972170303426254, 1.1061501349770482, 1.1131943298458467, 1.1149985012338646, 1.1201913706822915, 1.122778855720293, 1.1305088155450391, 1.1426496895265261, 1.158829537788564, 1.1672831798963719, 1.1764171111098345, 1.1854320252021489, 1.1959338763626908, 1.2118635240911466, 1.227527211103017, 1.2391052428497749, 1.247564638745117, 1.2551440523276398, 1.261198332514682, 1.2649431142182512, 1.268671717144299, 1.2754685291797874, 1.27916143047216, 1.2828401885555656, 1.2850839467893178, 1.2873239863224402, 1.2873239863224402, 1.2895603256873185, 1.2895603256873185, 1.291194449781369, 1.2950530630934047, 1.2997046899987499, 1.303533537108444, 1.308942480415857, 1.315736348816879, 1.3218592697230505, 1.3271602239128624, 1.3346163980640178, 1.3390873375515133, 1.345713400904896, 1.3508867171144778, 1.357449425193567, 1.3618257768033022, 1.3683331605051896, 1.3769783973340752, 1.3855457293848719, 1.3898005160042362, 1.3947358340411016, 1.397517428218796, 1.4023967343235382, 1.4051264847055795, 1.4099487520922023, 1.412627600186136, 1.4152814082111074, 1.418563387762869, 1.4224505299816406, 1.4256469414936013, 1.4281762769134871, 1.4300568896737664, 1.432542925013107, 1.4350040031876894, 1.4362254340385592, 1.434116373942766, 1.434116373942766, 1.4298891146597965, 1.4268684719357903, 1.4271621176930165, 1.424951401352896, 1.4232271669635053, 1.4240976713848383, 1.423730726444365, 1.4195189527861016, 1.4146415007251938, 1.4079965658297477, 1.3968005660474871, 1.3893116436848372, 1.3784687831167173, 1.3719777126988812, 1.3654052980654807, 1.3587509462874514, 1.3492655307228818, 1.3419767712188282, 1.3387653366621228, 1.3350736530644212, 1.3281350029696768, 1.316499961318317, 1.2569068612849612, 1.2298777438224218, 1.2078373146022026, 1.1854211218068533, 1.1233127716707567, 1.0993149240557654, 1.0799226700058255, 1.057362593923657, 1.0285252942801162, 1.0049067031636618, 0.9807624193783314, 0.9653879517389763, 0.9529222938270454, 0.9434721417761208, 0.9339328192852163, 0.927522267340715, 0.9178279122560108, 0.9080365634051714, 0.8981450439331227, 0.8914933590310434, 0.8847946531315677, 0.8814273228628428, 0.8780478237865117, 0.8780478237865117, 0.8746560146652385, 0.8746560146652385, 0.8712517515438596, 0.8712517515438596, 0.8712517515438596, 0.8678348876757358, 0.8678348876757358, 0.8678348876757358, 0.8814273228628428, 0.921070067919289, 0.937122759784622, 0.9529222938270454, 0.9653879517389763, 0.9777055650570815, 0.9898805591803235, 0.9989208614180985, 1.010858625227394, 1.0256007299170904, 1.037254396623326, 1.0487876182276177, 1.057362593923657, 1.065874177189687, 1.0743238777928688, 1.0799226700058255, 1.0882724365842529, 1.0965640712134574, 1.110257156364977, 1.1211020752314194, 1.1291728575199371, 1.1371925994424055, 1.1451614084707398, 1.1504455324454426, 1.158331791296133, 1.1661698611033733, 1.1739607091115905, 1.1894035169884263, 1.1995997123300277, 1.2097187981006587, 1.2197626971173876, 1.2247565751320109, 1.2322144175490917, 1.2371643387456235, 1.2420957858560613, 1.2470098750130445, 1.2543498024993591, 1.2689165226111976, 1.2785456438442395, 1.2833358020728187, 1.2904924609752835, 1.29524360390157, 1.297614292219965, 1.302794909614231, 1.3075083800198573, 1.3122061064151456, 1.319674819444792, 1.3243355023878962, 1.3313005682203267, 1.3363711747493738, 1.3409827356663562, 1.3455796549371923, 1.35060622677213, 1.352892554565828, 1.357896247987433, 1.3606108116985758, 1.3628833781728984, 1.367855803605291, 1.3728120543834648, 1.3777530912336118, 1.3826799389229087, 1.3875910761310795, 1.3924883408833566, 1.3973702161465205, 1.4022385249215377, 1.4066705777504291, 1.4115123443068356, 1.4141369883798067, 1.4163393367286878, 1.4189569726504987, 1.4193728496207554, 1.421569069612289, 1.4241764933784575, 1.426779230519097, 1.4289673305022557, 1.4315624569702712, 1.4341529609560901, 1.436738882990146, 1.4393202630955713, 1.4414937412278641, 1.4440676690006917, 1.4466371158334284, 1.449202067473796, 1.4535227499038585, 1.4560776181563455, 1.4586280671991483, 1.461174921671864, 1.4662540101709556, 1.4687870714875089, 1.4717045481270457, 1.4742274292390884, 1.476746068083987, 1.4792604496898285, 1.4796421634305437, 1.4821515513567511, 1.484655943490001, 1.484655943490001, 1.484655943490001, 1.4850330484332748, 1.487156171317305, 1.4875316990474996, 1.4875316990474996, 1.4875316990474996, 1.4903986197432466, 1.4907697057670077, 1.4932576583046198, 1.4939920894198209, 1.4964722131236134, 1.4968355650403076, 1.4993100489771554, 1.4993100489771554, 1.4996703680059453, 1.4996703680059453]

    T = len(th1) - 2
    dmp = DMP(T)

    w1, PHI1 = dmp.imitation(np.array(th1))
    w2, PHI2 = dmp.imitation(np.array(th2))

    w1_new, w2_new = PoWER_roll_out(w1, w2, th1[-1], th2[-1], th1[2], th2[2], PHI1, PHI2)

    predict_s1 = dmp.predict(w1_new, th1[2], th1[-1], PHI1)
    predict_s2 = dmp.predict(w2_new, th2[2], th2[-1], PHI2)
    original_ss1 = dmp.predict(w1, th1[2], th1[-1], PHI1)
    original_ss2 = dmp.predict(w2, th2[2], th2[-1], PHI2)

    plot_letter(predict_s1, predict_s2)



